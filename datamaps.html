<html>
<head>
	<script type="text/javascript" src="http://code.jquery.com/jquery-2.1.1.min.js"></script>
	<script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.7.0/underscore-min.js"></script>
	<script type="text/javascript" src="/js/xml.min.js"></script>
	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
	  <script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>

	<script src="http://d3js.org/d3.v3.min.js"></script>       <!-- D3.js -->
	<script src="http://d3js.org/topojson.v1.min.js"></script> <!-- topoJSON -->
	<script src="js/datamaps.js"></script>                     <!-- Datamaps -->
	<script src="js/datamaps.usa.min.js"></script>             <!-- Datamaps USA data -->
	<script src="js/fetchData.js"></script>
</head>
<body>
	<div id="container" style="position: relative; width: 1000; height: 1000px;"></div>
	<script>

		// Waterfall map creation
		setupMap(function(){
			fetchData(function(data){
				renderData(data);
			});
		});

		// When data comes back
		function setupMap(next){
			console.log("\nSetting up the Map...");

		    map = new Datamap({
		    	element: document.getElementById('container'),
		    	scope: 'usa',
		    	setProjection: projection,
		    	done: function() {
		    		console.log("Blank Map Created");
		    	}, 
		    	geographyConfig: {
	            	popupTemplate: function(geo, data) {
	                	return ['<div class="hoverinfo"><strong>' + geo.properties.name + '</strong></div>'].join('');
	            	},
	            	popupOnHover: false, //disable the popup while hovering
	        	}
		    });

		    // Configure projection (scale, etc)
		    function projection(element){
		    	var boston = [-71.2, 42.9];
		    	var usa = [19, -3];

				var projection = d3.geo.equirectangular()
					.center(boston)
					.scale(20000);

				return { 
					path: d3.geo.path().projection(projection), 
					projection: projection 
				};
		    }

		    next();
		}


		function renderData(data){
			console.log("\nConverting Data points....");

			// var dataPoints = [];

			// _.each(data, function(p){

			// 	dataPoints.push({
			// 		name: p.date,
			// 		latitude: parseFloat(p.location[1]),
		 //    		longitude: parseFloat(p.location[0]),
		 //    		radius: 3
		 //    	});
			// })
			
			// console.log("Placing " + dataPoints.length + " Data points....");

			// //draw bubbles for bubbles
			// map.bubbles(dataPoints, {
			//     popupTemplate: function (geo, data) { 
			//             return ['<div class="hoverinfo">' +  data.name + '</div>'].join('');
			//     }
			// });

			var arcs = [];

			var prev = {};

			_.each(data, function(p){
				if (!prev){
					return
				}

				var current = {
					latitude: parseFloat(p.location[1]),
		    		longitude: parseFloat(p.location[0]),
				}

				arcs.push({
				    origin: prev,
				    destination: current,
				});

				prev = current;

			})
			
			console.log("Placing " + arcs.length + " Data points....");

			//draw bubbles for bubbles
			map.arc(arcs, {
			    popupTemplate: function (geo, data) { 
			            return ['<div class="hoverinfo">' +  data.name + '</div>'].join('');
			    }
			});
		}

	</script>
</body>

</html>